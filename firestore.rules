/**
 * @fileoverview Firestore Security Rules for Hardik's Photography Portfolio.
 *
 * Core Philosophy:
 * This ruleset enforces a strict ownership model, where only authenticated users can manage portfolios and their related data. All data is nested under a portfolio ID, ensuring clear ownership and access control.
 *
 * Data Structure:
 * The data is organized hierarchically under `/portfolios/{portfolioId}`. Each portfolio contains subcollections for photographs, testimonials, and contact information.
 *
 * Key Security Decisions:
 * - Access to portfolio and its contents is restricted to authenticated users.
 * - The rules validate that the portfolioId in subcollections matches the path.
 * - Data shapes are NOT strictly validated in this prototyping phase to allow for rapid iteration.
 *
 * Denormalization for Authorization:
 * The `portfolioId` is denormalized onto all subcollection documents to allow for simple ownership checks without requiring additional `get()` calls. This ensures that photographs, testimonials, and contact info can only be created, updated, or deleted within their parent portfolio.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the /portfolios/{portfolioId} collection.
     * @path /portfolios/{portfolioId}
     * @allow (create, update, delete) if request.auth.uid is not null.
     * @allow (get, list) if request.auth.uid is not null.
     * @deny (create) if request.auth.uid is null.
     * @principle Enforces portfolio ownership for all operations.
     */
    match /portfolios/{portfolioId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn();
      }

      function isExistingOwner() {
        return isOwner() && resource != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isExistingOwner();
      allow delete: if isExistingOwner();
    }

    /**
     * @description Controls access to the /portfolios/{portfolioId}/photographs/{photographId} collection.
     * @path /portfolios/{portfolioId}/photographs/{photographId}
     * @allow (create, update, delete) if isSignedIn() && request.resource.data.portfolioId == portfolioId.
     * @allow (get, list) if isSignedIn().
     * @deny (create) if !isSignedIn().
     * @principle Enforces photograph ownership and validates portfolioId on write.
     */
    match /portfolios/{portfolioId}/photographs/{photographId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn();
      }

      function isExistingOwner() {
        return isOwner() && resource != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.portfolioId == portfolioId;
      allow update: if isExistingOwner() && request.resource.data.portfolioId == portfolioId;
      allow delete: if isExistingOwner() && request.resource.data.portfolioId == portfolioId;
    }

    /**
     * @description Controls access to the /portfolios/{portfolioId}/testimonials/{testimonialId} collection.
     * @path /portfolios/{portfolioId}/testimonials/{testimonialId}
     * @allow (create, update, delete) if isSignedIn() && request.resource.data.portfolioId == portfolioId.
     * @allow (get, list) if isSignedIn().
     * @deny (create) if !isSignedIn().
     * @principle Enforces testimonial ownership and validates portfolioId on write.
     */
    match /portfolios/{portfolioId}/testimonials/{testimonialId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn();
      }
      function isExistingOwner() {
        return isOwner() && resource != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.portfolioId == portfolioId;
      allow update: if isExistingOwner() && request.resource.data.portfolioId == portfolioId;
      allow delete: if isExistingOwner() && request.resource.data.portfolioId == portfolioId;
    }

    /**
     * @description Controls access to the /portfolios/{portfolioId}/contactInfo/{contactInfoId} collection.
     * @path /portfolios/{portfolioId}/contactInfo/{contactInfoId}
     * @allow (create, update, delete) if isSignedIn() && request.resource.data.portfolioId == portfolioId.
     * @allow (get, list) if isSignedIn().
     * @deny (create) if !isSignedIn().
     * @principle Enforces contactInfo ownership and validates portfolioId on write.
     */
    match /portfolios/{portfolioId}/contactInfo/{contactInfoId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn();
      }
      function isExistingOwner() {
        return isOwner() && resource != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.portfolioId == portfolioId;
      allow update: if isExistingOwner() && request.resource.data.portfolioId == portfolioId;
      allow delete: if isExistingOwner() && request.resource.data.portfolioId == portfolioId;
    }
  }
}